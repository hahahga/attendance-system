{% extends "base.html" %}

{% block title %}登录 - 考勤系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h4 class="mb-0"><i class="bi bi-box-arrow-in-right"></i> 考勤系统登录</h4>
            </div>
            <div class="card-body">
                <form id="loginForm" method="post" action="/login">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="rememberMe" name="remember_me">
                        <label class="form-check-label" for="rememberMe">记住我</label>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right"></i> 登录
                        </button>
                    </div>
                </form>
                
                <hr>
                
                <div class="text-center">
                    <a href="/forgot-password" class="text-decoration-none">忘记密码?</a>
                </div>
                
                {% if error %}
                <div class="alert alert-danger mt-3" role="alert">
                    {{ error }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- 人脸识别登录选项 -->
        <div class="card shadow mt-3">
            <div class="card-header bg-info text-white text-center">
                <h5 class="mb-0"><i class="bi bi-camera"></i> 人脸识别登录</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <p>使用人脸识别快速登录</p>
                    <button id="faceLoginBtn" class="btn btn-info">
                        <i class="bi bi-camera-video"></i> 开始人脸识别
                    </button>
                </div>
                
                <!-- 摄像头视频流 -->
                <div id="cameraContainer" class="mt-3 d-none">
                    <video id="video" width="100%" autoplay></video>
                    <canvas id="canvas" class="d-none"></canvas>
                    <div class="mt-2 d-grid gap-2">
                        <button id="captureBtn" class="btn btn-success">
                            <i class="bi bi-camera"></i> 拍照识别
                        </button>
                        <button id="cancelCameraBtn" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> 取消
                        </button>
                    </div>
                </div>
                
                <!-- 识别结果 -->
                <div id="faceResult" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 密码显示/隐藏切换
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('password');
    
    togglePassword.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // 切换图标
        const icon = this.querySelector('i');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
    });
    
    // 人脸识别登录
    const faceLoginBtn = document.getElementById('faceLoginBtn');
    const cameraContainer = document.getElementById('cameraContainer');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    const faceResult = document.getElementById('faceResult');
    
    let stream = null;
    
    // 开始人脸识别
    faceLoginBtn.addEventListener('click', async function() {
        try {
            // 获取摄像头权限
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            
            // 显示摄像头容器
            cameraContainer.classList.remove('d-none');
            faceLoginBtn.disabled = true;
        } catch (error) {
            console.error('无法访问摄像头:', error);
            showToast('无法访问摄像头，请检查权限设置', 'danger');
        }
    });
    
    // 拍照识别
    captureBtn.addEventListener('click', function() {
        // 设置canvas尺寸与视频一致
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // 将视频帧绘制到canvas
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // 获取图片数据
        canvas.toBlob(function(blob) {
            // 创建FormData
            const formData = new FormData();
            formData.append('image', blob, 'face.jpg');
            
            // 发送识别请求
            axios.post('/api/v1/auth/face-login', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
            .then(response => {
                const data = response.data;
                
                if (data.success) {
                    faceResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 识别成功: ${data.user.full_name || data.user.username}
                        </div>
                    `;
                    
                    // 延迟跳转
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    faceResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> 识别失败: ${data.message}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('人脸识别失败:', error);
                faceResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> 识别失败: ${error.response?.data?.detail || '服务器错误'}
                    </div>
                `;
            });
        }, 'image/jpeg');
    });
    
    // 取消摄像头
    cancelCameraBtn.addEventListener('click', function() {
        stopCamera();
    });
    
    // 停止摄像头
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        
        cameraContainer.classList.add('d-none');
        faceLoginBtn.disabled = false;
        faceResult.innerHTML = '';
    }
    
    // 页面卸载时停止摄像头
    window.addEventListener('beforeunload', function() {
        stopCamera();
    });
    
    // 表单提交处理
    const loginForm = document.getElementById('loginForm');
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(loginForm);
        const data = Object.fromEntries(formData.entries());
        
        axios.post('/api/v1/auth/login', data)
            .then(response => {
                // 保存token
                localStorage.setItem('access_token', response.data.access_token);
                
                showToast('登录成功', 'success');
                
                // 跳转到首页
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            })
            .catch(error => {
                console.error('登录失败:', error);
                showToast(error.response?.data?.detail || '登录失败', 'danger');
            });
    });
});
</script>
{% endblock %}