{% extends "base.html" %}

{% block title %}人脸管理 - 考勤系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">人脸管理</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="refreshBtn">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 人脸采集区域 -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">人脸采集</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="userSelect" class="form-label">选择用户</label>
                    <select class="form-select" id="userSelect">
                        <option value="">请选择用户</option>
                        <!-- 用户选项将通过JavaScript填充 -->
                    </select>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-center">
                        <div class="position-relative">
                            <video id="video" width="400" height="300" autoplay class="border rounded"></video>
                            <canvas id="canvas" width="400" height="300" class="d-none"></canvas>
                            <div id="faceDetectionOverlay" class="position-absolute top-0 start-0 w-100 h-100 pointer-events-none">
                                <!-- 人脸检测框将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-primary" id="startCameraBtn">
                        <i class="bi bi-camera-video"></i> 开启摄像头
                    </button>
                    <button type="button" class="btn btn-success" id="captureBtn" disabled>
                        <i class="bi bi-camera"></i> 拍照
                    </button>
                    <button type="button" class="btn btn-warning" id="retakeBtn" disabled>
                        <i class="bi bi-arrow-clockwise"></i> 重拍
                    </button>
                    <button type="button" class="btn btn-danger" id="stopCameraBtn" disabled>
                        <i class="bi bi-camera-video-off"></i> 关闭摄像头
                    </button>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info d-none" id="captureStatus">
                        <i class="bi bi-info-circle"></i> <span id="statusMessage"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 人脸识别测试 -->
        <div class="card shadow mt-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">人脸识别测试</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-center">
                        <div class="position-relative">
                            <video id="recognitionVideo" width="400" height="300" autoplay class="border rounded"></video>
                            <canvas id="recognitionCanvas" width="400" height="300" class="d-none"></canvas>
                            <div id="recognitionOverlay" class="position-absolute top-0 start-0 w-100 h-100 pointer-events-none">
                                <!-- 识别结果将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-primary" id="startRecognitionCameraBtn">
                        <i class="bi bi-camera-video"></i> 开启摄像头
                    </button>
                    <button type="button" class="btn btn-success" id="startRecognitionBtn" disabled>
                        <i class="bi bi-person-check"></i> 开始识别
                    </button>
                    <button type="button" class="btn btn-warning" id="stopRecognitionBtn" disabled>
                        <i class="bi bi-stop-circle"></i> 停止识别
                    </button>
                    <button type="button" class="btn btn-danger" id="stopRecognitionCameraBtn" disabled>
                        <i class="bi bi-camera-video-off"></i> 关闭摄像头
                    </button>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-success d-none" id="recognitionResult">
                        <i class="bi bi-check-circle"></i> <span id="recognitionMessage"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 人脸数据管理 -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">人脸数据管理</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="filterDropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="bi bi-funnel"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                        <a class="dropdown-item filter-item" href="#" data-filter="all">全部</a>
                        <a class="dropdown-item filter-item" href="#" data-filter="active">活跃</a>
                        <a class="dropdown-item filter-item" href="#" data-filter="inactive">非活跃</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="faceDataTable">
                        <thead>
                            <tr>
                                <th>用户</th>
                                <th>人脸数据</th>
                                <th>创建时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JavaScript填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <nav aria-label="人脸数据分页">
                    <ul class="pagination justify-content-center" id="faceDataPagination">
                        <!-- 分页按钮将通过JavaScript生成 -->
                    </ul>
                </nav>
            </div>
        </div>
        
        <!-- 人脸数据统计 -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">人脸数据统计</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-4">
                        <div class="border rounded p-3">
                            <h4 class="mb-1" id="totalFaceCount">0</h4>
                            <p class="mb-0 text-muted">总人脸数据</p>
                        </div>
                    </div>
                    <div class="col-6 mb-4">
                        <div class="border rounded p-3">
                            <h4 class="mb-1" id="activeFaceCount">0</h4>
                            <p class="mb-0 text-muted">活跃数据</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3">
                            <h4 class="mb-1" id="todayAddedCount">0</h4>
                            <p class="mb-0 text-muted">今日新增</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-3">
                            <h4 class="mb-1" id="recognitionAccuracy">0%</h4>
                            <p class="mb-0 text-muted">识别准确率</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 人脸详情模态框 -->
<div class="modal fade" id="faceDetailModal" tabindex="-1" aria-labelledby="faceDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="faceDetailModalLabel">人脸数据详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">用户</label>
                            <p class="form-control-plaintext" id="detailUserName">--</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">部门</label>
                            <p class="form-control-plaintext" id="detailUserDepartment">--</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">创建时间</label>
                            <p class="form-control-plaintext" id="detailCreateTime">--</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">人脸图像</label>
                            <div class="text-center">
                                <img id="detailFaceImage" src="" alt="人脸图像" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">使用统计</label>
                    <div class="row">
                        <div class="col-4 text-center">
                            <h5 id="detailUsageCount">0</h5>
                            <small class="text-muted">使用次数</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 id="detailSuccessRate">0%</h5>
                            <small class="text-muted">识别成功率</small>
                        </div>
                        <div class="col-4 text-center">
                            <h5 id="detailLastUsed">--</h5>
                            <small class="text-muted">最后使用</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-danger" id="deleteFaceBtn">删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化变量
    let videoStream = null;
    let recognitionVideoStream = null;
    let currentFaceId = null;
    let recognitionInterval = null;
    let currentPage = 1;
    let currentFilter = 'all';
    
    // 初始化页面
    initPage();
    
    // 绑定事件
    bindEvents();
    
    // 初始化页面
    function initPage() {
        loadUsers();
        loadFaceData();
        loadFaceStatistics();
    }
    
    // 绑定事件
    function bindEvents() {
        // 摄像头控制
        document.getElementById('startCameraBtn').addEventListener('click', startCamera);
        document.getElementById('stopCameraBtn').addEventListener('click', stopCamera);
        document.getElementById('captureBtn').addEventListener('click', captureFace);
        document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
        
        // 人脸识别控制
        document.getElementById('startRecognitionCameraBtn').addEventListener('click', startRecognitionCamera);
        document.getElementById('stopRecognitionCameraBtn').addEventListener('click', stopRecognitionCamera);
        document.getElementById('startRecognitionBtn').addEventListener('click', startRecognition);
        document.getElementById('stopRecognitionBtn').addEventListener('click', stopRecognition);
        
        // 刷新按钮
        document.getElementById('refreshBtn').addEventListener('click', function() {
            loadFaceData();
            loadFaceStatistics();
        });
        
        // 筛选器
        document.querySelectorAll('.filter-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                currentFilter = this.getAttribute('data-filter');
                currentPage = 1;
                loadFaceData();
            });
        });
        
        // 删除人脸数据
        document.getElementById('deleteFaceBtn').addEventListener('click', deleteFaceData);
    }
    
    // 加载用户列表
    function loadUsers() {
        axios.get('/api/v1/users/list')
            .then(response => {
                const users = response.data;
                const userSelect = document.getElementById('userSelect');
                
                // 清空现有选项（保留默认选项）
                while (userSelect.children.length > 1) {
                    userSelect.removeChild(userSelect.lastChild);
                }
                
                // 添加用户选项
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.employee_id})`;
                    userSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('加载用户列表失败:', error);
            });
    }
    
    // 开启摄像头
    function startCamera() {
        const video = document.getElementById('video');
        const userSelect = document.getElementById('userSelect');
        
        if (!userSelect.value) {
            showToast('请先选择用户', 'warning');
            return;
        }
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoStream = stream;
                video.srcObject = stream;
                
                // 更新按钮状态
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('stopCameraBtn').disabled = false;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('userSelect').disabled = true;
                
                // 开始人脸检测
                startFaceDetection();
            })
            .catch(error => {
                console.error('无法访问摄像头:', error);
                showToast('无法访问摄像头，请检查权限设置', 'danger');
            });
    }
    
    // 关闭摄像头
    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        const video = document.getElementById('video');
        video.srcObject = null;
        
        // 更新按钮状态
        document.getElementById('startCameraBtn').disabled = false;
        document.getElementById('stopCameraBtn').disabled = true;
        document.getElementById('captureBtn').disabled = true;
        document.getElementById('userSelect').disabled = false;
        
        // 清除人脸检测
        clearFaceDetection();
    }
    
    // 开始人脸检测
    function startFaceDetection() {
        const video = document.getElementById('video');
        const overlay = document.getElementById('faceDetectionOverlay');
        
        // 这里应该调用后端API进行人脸检测
        // 由于是演示，我们模拟检测过程
        const detectionInterval = setInterval(() => {
            // 模拟检测到人脸
            if (Math.random() > 0.3) {
                // 绘制人脸框
                overlay.innerHTML = `
                    <div style="position: absolute; top: 30%; left: 35%; width: 30%; height: 40%; border: 2px solid #4CAF50; border-radius: 5px;"></div>
                `;
            } else {
                overlay.innerHTML = '';
            }
        }, 100);
        
        // 保存interval ID以便后续清除
        video.dataset.detectionInterval = detectionInterval;
    }
    
    // 清除人脸检测
    function clearFaceDetection() {
        const video = document.getElementById('video');
        const overlay = document.getElementById('faceDetectionOverlay');
        
        if (video.dataset.detectionInterval) {
            clearInterval(video.dataset.detectionInterval);
            delete video.dataset.detectionInterval;
        }
        
        overlay.innerHTML = '';
    }
    
    // 拍照
    function captureFace() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const userSelect = document.getElementById('userSelect');
        
        // 绘制当前视频帧到canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // 获取图像数据
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('user_id', userSelect.value);
            formData.append('face_image', blob);
            
            // 显示加载提示
            showCaptureStatus('正在上传人脸数据...', 'info');
            
            // 上传人脸数据
            axios.post('/api/v1/face/register', formData)
                .then(response => {
                    showCaptureStatus('人脸数据上传成功！', 'success');
                    currentFaceId = response.data.face_id;
                    
                    // 更新按钮状态
                    document.getElementById('captureBtn').disabled = true;
                    document.getElementById('retakeBtn').disabled = false;
                    
                    // 刷新人脸数据列表
                    loadFaceData();
                    loadFaceStatistics();
                })
                .catch(error => {
                    console.error('上传人脸数据失败:', error);
                    showCaptureStatus(error.response?.data?.detail || '上传失败', 'danger');
                });
        });
    }
    
    // 重拍
    function retakePhoto() {
        // 重置按钮状态
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('retakeBtn').disabled = true;
        
        // 清除状态消息
        document.getElementById('captureStatus').classList.add('d-none');
        
        currentFaceId = null;
    }
    
    // 显示拍照状态
    function showCaptureStatus(message, type) {
        const statusDiv = document.getElementById('captureStatus');
        const messageSpan = document.getElementById('statusMessage');
        
        statusDiv.classList.remove('d-none', 'alert-info', 'alert-success', 'alert-danger');
        statusDiv.classList.add(`alert-${type}`);
        messageSpan.textContent = message;
    }
    
    // 开启识别摄像头
    function startRecognitionCamera() {
        const video = document.getElementById('recognitionVideo');
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                recognitionVideoStream = stream;
                video.srcObject = stream;
                
                // 更新按钮状态
                document.getElementById('startRecognitionCameraBtn').disabled = true;
                document.getElementById('stopRecognitionCameraBtn').disabled = false;
                document.getElementById('startRecognitionBtn').disabled = false;
            })
            .catch(error => {
                console.error('无法访问摄像头:', error);
                showToast('无法访问摄像头，请检查权限设置', 'danger');
            });
    }
    
    // 关闭识别摄像头
    function stopRecognitionCamera() {
        if (recognitionVideoStream) {
            recognitionVideoStream.getTracks().forEach(track => track.stop());
            recognitionVideoStream = null;
        }
        
        const video = document.getElementById('recognitionVideo');
        video.srcObject = null;
        
        // 如果正在识别，先停止识别
        if (recognitionInterval) {
            stopRecognition();
        }
        
        // 更新按钮状态
        document.getElementById('startRecognitionCameraBtn').disabled = false;
        document.getElementById('stopRecognitionCameraBtn').disabled = true;
        document.getElementById('startRecognitionBtn').disabled = true;
        
        // 清除识别结果
        document.getElementById('recognitionOverlay').innerHTML = '';
        document.getElementById('recognitionResult').classList.add('d-none');
    }
    
    // 开始人脸识别
    function startRecognition() {
        const video = document.getElementById('recognitionVideo');
        const canvas = document.getElementById('recognitionCanvas');
        const context = canvas.getContext('2d');
        const overlay = document.getElementById('recognitionOverlay');
        
        // 更新按钮状态
        document.getElementById('startRecognitionBtn').disabled = true;
        document.getElementById('stopRecognitionBtn').disabled = false;
        
        // 设置定时识别
        recognitionInterval = setInterval(() => {
            // 绘制当前视频帧到canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // 获取图像数据
            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('face_image', blob);
                
                // 进行人脸识别
                axios.post('/api/v1/face/recognize', formData)
                    .then(response => {
                        const data = response.data;
                        
                        if (data.recognized) {
                            // 显示识别结果
                            overlay.innerHTML = `
                                <div style="position: absolute; top: 30%; left: 35%; width: 30%; height: 40%; border: 2px solid #4CAF50; border-radius: 5px;">
                                    <div style="position: absolute; bottom: -25px; left: 0; right: 0; text-align: center; background: rgba(0,0,0,0.7); color: white; padding: 2px; font-size: 12px;">
                                        ${data.user.name} (${data.user.employee_id})
                                    </div>
                                </div>
                            `;
                            
                            // 显示识别消息
                            document.getElementById('recognitionResult').classList.remove('d-none');
                            document.getElementById('recognitionMessage').textContent = `识别成功：${data.user.name} (${data.user.employee_id})`;
                        } else {
                            // 清除识别结果
                            overlay.innerHTML = '';
                            document.getElementById('recognitionResult').classList.add('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('人脸识别失败:', error);
                        // 不显示错误，避免频繁提示
                    });
            });
        }, 1000);
    }
    
    // 停止人脸识别
    function stopRecognition() {
        if (recognitionInterval) {
            clearInterval(recognitionInterval);
            recognitionInterval = null;
        }
        
        // 更新按钮状态
        document.getElementById('startRecognitionBtn').disabled = false;
        document.getElementById('stopRecognitionBtn').disabled = true;
        
        // 清除识别结果
        document.getElementById('recognitionOverlay').innerHTML = '';
        document.getElementById('recognitionResult').classList.add('d-none');
    }
    
    // 加载人脸数据
    function loadFaceData() {
        let url = `/api/v1/face/list?page=${currentPage}&filter=${currentFilter}`;
        
        axios.get(url)
            .then(response => {
                const data = response.data;
                const tbody = document.querySelector('#faceDataTable tbody');
                
                tbody.innerHTML = '';
                
                data.items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // 状态样式
                    let statusClass = '';
                    let statusText = '';
                    
                    if (item.is_active) {
                        statusClass = 'text-success';
                        statusText = '活跃';
                    } else {
                        statusClass = 'text-secondary';
                        statusText = '非活跃';
                    }
                    
                    row.innerHTML = `
                        <td>${item.user.name}</td>
                        <td>
                            <img src="${item.face_image_url}" alt="人脸" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                        </td>
                        <td>${item.created_at}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info view-face-btn" data-id="${item.id}">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-danger delete-face-btn" data-id="${item.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 绑定查看和删除按钮事件
                document.querySelectorAll('.view-face-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        viewFaceDetail(this.getAttribute('data-id'));
                    });
                });
                
                document.querySelectorAll('.delete-face-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (confirm('确定要删除这个人脸数据吗？')) {
                            deleteFaceData(this.getAttribute('data-id'));
                        }
                    });
                });
                
                // 更新分页
                updatePagination(data.total_pages, data.current_page);
            })
            .catch(error => {
                console.error('加载人脸数据失败:', error);
            });
    }
    
    // 更新分页
    function updatePagination(totalPages, currentPage) {
        const pagination = document.getElementById('faceDataPagination');
        pagination.innerHTML = '';
        
        // 上一页
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>`;
        pagination.appendChild(prevLi);
        
        // 页码
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // 下一页
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>`;
        pagination.appendChild(nextLi);
        
        // 绑定分页点击事件
        document.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page > 0 && page <= totalPages) {
                    currentPage = page;
                    loadFaceData();
                }
            });
        });
    }
    
    // 查看人脸详情
    function viewFaceDetail(faceId) {
        axios.get(`/api/v1/face/detail/${faceId}`)
            .then(response => {
                const data = response.data;
                
                // 填充详情数据
                document.getElementById('detailUserName').textContent = data.user.name;
                document.getElementById('detailUserDepartment').textContent = data.user.department;
                document.getElementById('detailCreateTime').textContent = data.created_at;
                document.getElementById('detailFaceImage').src = data.face_image_url;
                document.getElementById('detailUsageCount').textContent = data.usage_count;
                document.getElementById('detailSuccessRate').textContent = (data.success_rate * 100).toFixed(1) + '%';
                document.getElementById('detailLastUsed').textContent = data.last_used || '--';
                
                // 保存当前人脸ID
                currentFaceId = faceId;
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('faceDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('加载人脸详情失败:', error);
                showToast('加载人脸详情失败', 'danger');
            });
    }
    
    // 删除人脸数据
    function deleteFaceData(faceId) {
        const id = faceId || currentFaceId;
        
        if (!id) return;
        
        axios.delete(`/api/v1/face/delete/${id}`)
            .then(response => {
                showToast('人脸数据删除成功', 'success');
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('faceDetailModal'));
                if (modal) modal.hide();
                
                // 刷新列表
                loadFaceData();
                loadFaceStatistics();
            })
            .catch(error => {
                console.error('删除人脸数据失败:', error);
                showToast(error.response?.data?.detail || '删除失败', 'danger');
            });
    }
    
    // 加载人脸统计
    function loadFaceStatistics() {
        axios.get('/api/v1/face/statistics')
            .then(response => {
                const data = response.data;
                
                document.getElementById('totalFaceCount').textContent = data.total_count || 0;
                document.getElementById('activeFaceCount').textContent = data.active_count || 0;
                document.getElementById('todayAddedCount').textContent = data.today_added || 0;
                document.getElementById('recognitionAccuracy').textContent = (data.recognition_accuracy * 100).toFixed(1) + '%';
            })
            .catch(error => {
                console.error('加载人脸统计失败:', error);
            });
    }
});
</script>
{% endblock %}