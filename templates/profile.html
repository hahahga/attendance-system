{% extends "base.html" %}

{% block title %}个人资料 - 考勤系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">个人资料</h1>
        </div>
    </div>
</div>

<div class="row">
    <!-- 个人信息卡片 -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-body text-center">
                <div class="mb-3">
                    <img src="{{ current_user.avatar_url or '/static/images/default-avatar.png' }}" alt="头像" class="rounded-circle" id="avatarPreview" style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <h4 class="card-title">{{ current_user.name }}</h4>
                <p class="card-text text-muted">{{ current_user.job_title }}</p>
                <p class="card-text">{{ current_user.department }}</p>
                
                <div class="d-flex justify-content-center mb-3">
                    <div class="text-center mx-3">
                        <h5 class="mb-0" id="attendanceRate">--</h5>
                        <small class="text-muted">出勤率</small>
                    </div>
                    <div class="text-center mx-3">
                        <h5 class="mb-0" id="totalDays">--</h5>
                        <small class="text-muted">出勤天数</small>
                    </div>
                    <div class="text-center mx-3">
                        <h5 class="mb-0" id="lateCount">--</h5>
                        <small class="text-muted">迟到次数</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                    <i class="bi bi-key"></i> 修改密码
                </button>
            </div>
        </div>
        
        <!-- 考勤统计卡片 -->
        <div class="card shadow mt-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">本月考勤统计</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>正常</span>
                        <span id="normalCount">0</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" role="progressbar" id="normalProgress" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>迟到</span>
                        <span id="lateCountDetail">0</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-warning" role="progressbar" id="lateProgress" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>早退</span>
                        <span id="earlyCountDetail">0</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-danger" role="progressbar" id="earlyProgress" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-1">
                        <span>缺勤</span>
                        <span id="absentCountDetail">0</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" role="progressbar" id="absentProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 个人信息表单 -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">基本信息</h6>
            </div>
            <div class="card-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ current_user.name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="employee_id" class="form-label">工号</label>
                            <input type="text" class="form-control" id="employee_id" name="employee_id" value="{{ current_user.employee_id }}" readonly>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ current_user.email }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="phone" name="phone" value="{{ current_user.phone }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="department" class="form-label">部门</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">请选择部门</option>
                                <option value="技术部" {% if current_user.department == '技术部' %}selected{% endif %}>技术部</option>
                                <option value="人事部" {% if current_user.department == '人事部' %}selected{% endif %}>人事部</option>
                                <option value="财务部" {% if current_user.department == '财务部' %}selected{% endif %}>财务部</option>
                                <option value="市场部" {% if current_user.department == '市场部' %}selected{% endif %}>市场部</option>
                                <option value="销售部" {% if current_user.department == '销售部' %}selected{% endif %}>销售部</option>
                                <option value="行政部" {% if current_user.department == '行政部' %}selected{% endif %}>行政部</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="job_title" class="form-label">职位</label>
                            <input type="text" class="form-control" id="job_title" name="job_title" value="{{ current_user.job_title }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="hire_date" class="form-label">入职日期</label>
                            <input type="date" class="form-control" id="hire_date" name="hire_date" value="{{ current_user.hire_date }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="avatar" class="form-label">头像</label>
                            <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">地址</label>
                        <textarea class="form-control" id="address" name="address" rows="2">{{ current_user.address or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bio" class="form-label">个人简介</label>
                        <textarea class="form-control" id="bio" name="bio" rows="3">{{ current_user.bio or '' }}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" id="resetBtn">重置</button>
                        <button type="submit" class="btn btn-primary">保存修改</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 考勤记录 -->
        <div class="card shadow">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">最近考勤记录</h6>
                <a href="{{ url_for('attendance_history') }}" class="btn btn-sm btn-outline-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="recentAttendanceTable">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>签到时间</th>
                                <th>签退时间</th>
                                <th>工作时长</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JavaScript填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 修改密码模态框 -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">修改密码</h5>
                <button type="button" class="btn-close" data-bs-toggle="modal" data-bs-target="#changePasswordModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                        <div class="form-text">密码长度至少8位，包含字母和数字</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="changePasswordBtn">确认修改</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化页面
    initPage();
    
    // 绑定事件
    bindEvents();
    
    // 初始化页面
    function initPage() {
        loadProfileStatistics();
        loadRecentAttendance();
    }
    
    // 绑定事件
    function bindEvents() {
        // 个人信息表单提交
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateProfile();
        });
        
        // 重置按钮
        document.getElementById('resetBtn').addEventListener('click', function() {
            resetForm();
        });
        
        // 头像预览
        document.getElementById('avatar').addEventListener('change', function(e) {
            previewAvatar(e.target.files[0]);
        });
        
        // 修改密码按钮
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            changePassword();
        });
    }
    
    // 加载个人统计信息
    function loadProfileStatistics() {
        axios.get('/api/v1/users/profile/statistics')
            .then(response => {
                const data = response.data;
                
                // 更新统计卡片
                document.getElementById('attendanceRate').textContent = (data.attendance_rate * 100).toFixed(1) + '%';
                document.getElementById('totalDays').textContent = data.total_days || 0;
                document.getElementById('lateCount').textContent = data.late_count || 0;
                
                // 更新本月考勤统计
                const monthStats = data.month_stats || {};
                const total = monthStats.normal + monthStats.late + monthStats.early + monthStats.absent;
                
                if (total > 0) {
                    document.getElementById('normalCount').textContent = monthStats.normal || 0;
                    document.getElementById('normalProgress').style.width = ((monthStats.normal / total) * 100).toFixed(1) + '%';
                    
                    document.getElementById('lateCountDetail').textContent = monthStats.late || 0;
                    document.getElementById('lateProgress').style.width = ((monthStats.late / total) * 100).toFixed(1) + '%';
                    
                    document.getElementById('earlyCountDetail').textContent = monthStats.early || 0;
                    document.getElementById('earlyProgress').style.width = ((monthStats.early / total) * 100).toFixed(1) + '%';
                    
                    document.getElementById('absentCountDetail').textContent = monthStats.absent || 0;
                    document.getElementById('absentProgress').style.width = ((monthStats.absent / total) * 100).toFixed(1) + '%';
                }
            })
            .catch(error => {
                console.error('加载个人统计信息失败:', error);
            });
    }
    
    // 加载最近考勤记录
    function loadRecentAttendance() {
        axios.get('/api/v1/users/profile/recent-attendance')
            .then(response => {
                const data = response.data;
                const tbody = document.querySelector('#recentAttendanceTable tbody');
                
                tbody.innerHTML = '';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // 状态样式
                    let statusClass = '';
                    let statusText = '';
                    
                    switch (item.status) {
                        case 'normal':
                            statusClass = 'text-success';
                            statusText = '正常';
                            break;
                        case 'late':
                            statusClass = 'text-warning';
                            statusText = '迟到';
                            break;
                        case 'early':
                            statusClass = 'text-danger';
                            statusText = '早退';
                            break;
                        case 'absent':
                            statusClass = 'text-info';
                            statusText = '缺勤';
                            break;
                        default:
                            statusClass = 'text-secondary';
                            statusText = '未知';
                    }
                    
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.check_in_time || '--'}</td>
                        <td>${item.check_out_time || '--'}</td>
                        <td>${item.working_hours || '--'}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('加载最近考勤记录失败:', error);
            });
    }
    
    // 更新个人信息
    function updateProfile() {
        const form = document.getElementById('profileForm');
        const formData = new FormData(form);
        
        // 显示加载提示
        showToast('正在保存个人信息...', 'info');
        
        axios.post('/api/v1/users/profile/update', formData)
            .then(response => {
                showToast('个人信息更新成功', 'success');
                
                // 如果有头像更新，刷新页面以显示新头像
                if (formData.has('avatar') && formData.get('avatar')) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('更新个人信息失败:', error);
                showToast(error.response?.data?.detail || '更新失败', 'danger');
            });
    }
    
    // 重置表单
    function resetForm() {
        const form = document.getElementById('profileForm');
        form.reset();
        
        // 重置头像预览
        document.getElementById('avatarPreview').src = "{{ current_user.avatar_url or '/static/images/default-avatar.png' }}";
    }
    
    // 预览头像
    function previewAvatar(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }
    
    // 修改密码
    function changePassword() {
        const form = document.getElementById('changePasswordForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // 验证密码
        if (data.new_password !== data.confirm_password) {
            showToast('两次输入的密码不一致', 'warning');
            return;
        }
        
        // 验证密码强度
        if (data.new_password.length < 8 || !/\d/.test(data.new_password) || !/[a-zA-Z]/.test(data.new_password)) {
            showToast('密码长度至少8位，且必须包含字母和数字', 'warning');
            return;
        }
        
        // 显示加载提示
        showToast('正在修改密码...', 'info');
        
        axios.post('/api/v1/users/profile/change-password', data)
            .then(response => {
                showToast('密码修改成功', 'success');
                
                // 清空表单
                form.reset();
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
            })
            .catch(error => {
                console.error('修改密码失败:', error);
                showToast(error.response?.data?.detail || '修改失败', 'danger');
            });
    }
});
</script>
{% endblock %}