{% extends "base.html" %}

{% block title %}修改密码{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h4>修改密码</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="change_password_form">
                        <div class="form-group">
                            <label for="current_password">当前密码</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                            <div class="invalid-feedback">
                                请输入当前密码
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="new_password">新密码</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                            <div class="invalid-feedback">
                                请输入新密码
                            </div>
                            <small class="form-text text-muted">密码长度至少为6位，建议包含字母、数字和特殊字符</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm_password">确认新密码</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            <div class="invalid-feedback">
                                两次输入的密码不一致
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">修改密码</button>
                            <a href="{{ url_for('profile') }}" class="btn btn-secondary">返回个人资料</a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>密码安全提示</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>不要使用过于简单的密码，如"123456"、"password"等</li>
                        <li>定期更换密码，建议每3-6个月更换一次</li>
                        <li>不要将密码告诉他人，包括同事和系统管理员</li>
                        <li>不要在公共场所或不安全的网络环境下修改密码</li>
                        <li>不同系统使用不同的密码，避免一个密码泄露导致多个账户被盗</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('change_password_form');
        
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // 重置验证状态
            form.classList.remove('was-validated');
            const inputs = form.querySelectorAll('input');
            inputs.forEach(input => {
                input.classList.remove('is-invalid');
            });
            
            // 获取表单数据
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            let isValid = true;
            
            // 验证当前密码
            if (!currentPassword) {
                document.getElementById('current_password').classList.add('is-invalid');
                isValid = false;
            }
            
            // 验证新密码
            if (!newPassword) {
                document.getElementById('new_password').classList.add('is-invalid');
                isValid = false;
            } else if (newPassword.length < 6) {
                document.getElementById('new_password').classList.add('is-invalid');
                document.getElementById('new_password').nextElementSibling.textContent = '密码长度至少为6位';
                isValid = false;
            }
            
            // 验证确认密码
            if (!confirmPassword) {
                document.getElementById('confirm_password').classList.add('is-invalid');
                isValid = false;
            } else if (newPassword !== confirmPassword) {
                document.getElementById('confirm_password').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // 提交表单
            fetch('/api/change_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('密码修改成功，请重新登录');
                    window.location.href = '/logout';
                } else {
                    alert(data.message || '密码修改失败');
                    if (data.field === 'current_password') {
                        document.getElementById('current_password').classList.add('is-invalid');
                        document.getElementById('current_password').nextElementSibling.textContent = data.message;
                    }
                }
            })
            .catch(error => {
                console.error('Error changing password:', error);
                alert('密码修改失败，请稍后再试');
            });
        });
    });
    
    // 获取CSRF令牌
    function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }
</script>
{% endblock %}