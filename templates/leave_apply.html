{% extends "base.html" %}

{% block title %}请假申请 - 考勤系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">请假申请</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <a href="/leave/history" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> 请假记录
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">新建请假申请</h5>
            </div>
            <div class="card-body">
                <form id="leaveApplicationForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="leaveType" class="form-label">请假类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="leaveType" name="leave_type" required>
                                <option value="">请选择请假类型</option>
                                <option value="事假">事假</option>
                                <option value="病假">病假</option>
                                <option value="年假">年假</option>
                                <option value="婚假">婚假</option>
                                <option value="产假">产假</option>
                                <option value="丧假">丧假</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="leaveDays" class="form-label">请假天数 <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="leaveDays" name="leave_days" min="0.5" step="0.5" required>
                            <div class="form-text">支持半天请假，请输入0.5的倍数</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">开始日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="startDate" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">结束日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="endDate" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">开始时间</label>
                            <select class="form-select" id="startTime" name="start_time">
                                <option value="全天">全天</option>
                                <option value="上午">上午</option>
                                <option value="下午">下午</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">结束时间</label>
                            <select class="form-select" id="endTime" name="end_time">
                                <option value="全天">全天</option>
                                <option value="上午">上午</option>
                                <option value="下午">下午</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">请假原因 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="4" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="attachment" class="form-label">附件</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-paperclip"></i></span>
                            <input type="file" class="form-control" id="attachment" name="attachment">
                        </div>
                        <div class="form-text">如病假需提供病假条等证明材料</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="approver" class="form-label">审批人 <span class="text-danger">*</span></label>
                        <select class="form-select" id="approver" name="approver_id" required>
                            <option value="">请选择审批人</option>
                            <!-- 审批人列表将通过JavaScript动态填充 -->
                        </select>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> 提交申请
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- 请假余额 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">请假余额</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>年假余额</span>
                        <span class="badge bg-primary" id="annualLeaveBalance">0天</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="annualLeaveProgress"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>事假余额</span>
                        <span class="badge bg-warning" id="personalLeaveBalance">0天</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="personalLeaveProgress"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>病假余额</span>
                        <span class="badge bg-success" id="sickLeaveBalance">0天</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="sickLeaveProgress"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 请假须知 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">请假须知</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-info-circle text-primary"></i> 请提前申请，特殊情况需事后补办</li>
                    <li class="mb-2"><i class="bi bi-info-circle text-primary"></i> 病假需提供医院证明</li>
                    <li class="mb-2"><i class="bi bi-info-circle text-primary"></i> 年假需提前一周申请</li>
                    <li class="mb-2"><i class="bi bi-info-circle text-primary"></i> 连续请假超过3天需部门负责人审批</li>
                    <li class="mb-2"><i class="bi bi-info-circle text-primary"></i> 请假期间请做好工作交接</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 最近申请记录 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">最近申请记录</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>申请日期</th>
                                <th>请假类型</th>
                                <th>请假时间</th>
                                <th>请假天数</th>
                                <th>审批人</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentLeaveTable">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <a href="/leave/history" class="btn btn-sm btn-outline-primary">查看全部记录</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 加载请假余额
    loadLeaveBalance();
    
    // 加载审批人列表
    loadApprovers();
    
    // 加载最近请假记录
    loadRecentLeaveApplications();
    
    // 表单提交处理
    const leaveApplicationForm = document.getElementById('leaveApplicationForm');
    leaveApplicationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 验证日期
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);
        
        if (endDate < startDate) {
            showToast('结束日期不能早于开始日期', 'danger');
            return;
        }
        
        // 验证请假天数
        const leaveDays = parseFloat(document.getElementById('leaveDays').value);
        if (leaveDays <= 0) {
            showToast('请假天数必须大于0', 'danger');
            return;
        }
        
        const formData = new FormData(leaveApplicationForm);
        
        axios.post('/api/v1/leave/apply', formData, {
            headers: {
                'Content-Type': 'multipart/form-data'
            }
        })
        .then(response => {
            showToast('请假申请提交成功', 'success');
            
            // 重置表单
            leaveApplicationForm.reset();
            
            // 重新加载数据
            loadLeaveBalance();
            loadRecentLeaveApplications();
        })
        .catch(error => {
            console.error('提交请假申请失败:', error);
            showToast(error.response?.data?.detail || '提交失败', 'danger');
        });
    });
    
    // 开始日期和结束日期变化时自动计算请假天数
    document.getElementById('startDate').addEventListener('change', calculateLeaveDays);
    document.getElementById('endDate').addEventListener('change', calculateLeaveDays);
    document.getElementById('startTime').addEventListener('change', calculateLeaveDays);
    document.getElementById('endTime').addEventListener('change', calculateLeaveDays);
    
    // 加载请假余额
    function loadLeaveBalance() {
        axios.get('/api/v1/leave/balance')
            .then(response => {
                const data = response.data;
                
                // 更新年假余额
                const annualLeaveBalance = data.annual_leave || 0;
                const annualLeaveTotal = data.annual_leave_total || 10;
                document.getElementById('annualLeaveBalance').textContent = `${annualLeaveBalance}天`;
                document.getElementById('annualLeaveProgress').style.width = `${(annualLeaveBalance / annualLeaveTotal) * 100}%`;
                
                // 更新事假余额
                const personalLeaveBalance = data.personal_leave || 0;
                const personalLeaveTotal = data.personal_leave_total || 5;
                document.getElementById('personalLeaveBalance').textContent = `${personalLeaveBalance}天`;
                document.getElementById('personalLeaveProgress').style.width = `${(personalLeaveBalance / personalLeaveTotal) * 100}%`;
                
                // 更新病假余额
                const sickLeaveBalance = data.sick_leave || 0;
                const sickLeaveTotal = data.sick_leave_total || 30;
                document.getElementById('sickLeaveBalance').textContent = `${sickLeaveBalance}天`;
                document.getElementById('sickLeaveProgress').style.width = `${(sickLeaveBalance / sickLeaveTotal) * 100}%`;
            })
            .catch(error => {
                console.error('加载请假余额失败:', error);
            });
    }
    
    // 加载审批人列表
    function loadApprovers() {
        axios.get('/api/v1/users/approvers')
            .then(response => {
                const approvers = response.data;
                const approverSelect = document.getElementById('approver');
                
                approvers.forEach(approver => {
                    const option = document.createElement('option');
                    option.value = approver.id;
                    option.textContent = `${approver.full_name} (${approver.department_name})`;
                    approverSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('加载审批人列表失败:', error);
            });
    }
    
    // 加载最近请假记录
    function loadRecentLeaveApplications() {
        axios.get('/api/v1/leave/recent')
            .then(response => {
                const data = response.data;
                const tbody = document.getElementById('recentLeaveTable');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">暂无记录</td></tr>';
                    return;
                }
                
                data.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.application_date}</td>
                        <td>${record.leave_type}</td>
                        <td>${record.start_date} 至 ${record.end_date}</td>
                        <td>${record.days}天</td>
                        <td>${record.approver_name}</td>
                        <td><span class="badge ${getLeaveStatusBadgeClass(record.status)}">${record.status}</span></td>
                        <td>
                            ${record.status === '待审批' ? 
                                `<button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${record.id}">
                                    <i class="bi bi-x-circle"></i> 取消
                                </button>` : 
                                `<button class="btn btn-sm btn-outline-info view-btn" data-id="${record.id}">
                                    <i class="bi bi-eye"></i> 查看
                                </button>`
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 添加按钮事件
                document.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const leaveId = this.getAttribute('data-id');
                        cancelLeaveApplication(leaveId);
                    });
                });
                
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const leaveId = this.getAttribute('data-id');
                        viewLeaveApplication(leaveId);
                    });
                });
            })
            .catch(error => {
                console.error('加载最近请假记录失败:', error);
            });
    }
    
    // 计算请假天数
    function calculateLeaveDays() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;
        
        if (!startDate || !endDate) {
            return;
        }
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        // 计算天数差
        let days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        // 如果是同一天且选择了上午/下午，则按半天计算
        if (days === 1) {
            if (startTime === '上午' && endTime === '上午') {
                days = 0.5;
            } else if (startTime === '下午' && endTime === '下午') {
                days = 0.5;
            }
        } else if (days > 1) {
            // 如果开始时间是下午，减去0.5天
            if (startTime === '下午') {
                days -= 0.5;
            }
            
            // 如果结束时间是上午，减去0.5天
            if (endTime === '上午') {
                days -= 0.5;
            }
        }
        
        // 更新请假天数输入框
        document.getElementById('leaveDays').value = days.toFixed(1);
    }
    
    // 取消请假申请
    function cancelLeaveApplication(leaveId) {
        if (confirm('确定要取消此请假申请吗？')) {
            axios.delete(`/api/v1/leave/${leaveId}`)
                .then(response => {
                    showToast('请假申请已取消', 'success');
                    loadRecentLeaveApplications();
                })
                .catch(error => {
                    console.error('取消请假申请失败:', error);
                    showToast(error.response?.data?.detail || '取消失败', 'danger');
                });
        }
    }
    
    // 查看请假申请详情
    function viewLeaveApplication(leaveId) {
        // 这里可以实现查看详情的逻辑，比如打开一个模态框显示详细信息
        window.location.href = `/leave/detail/${leaveId}`;
    }
    
    // 获取请假状态徽章样式
    function getLeaveStatusBadgeClass(status) {
        switch(status) {
            case '已批准':
                return 'bg-success';
            case '已拒绝':
                return 'bg-danger';
            case '待审批':
                return 'bg-warning';
            case '已取消':
                return 'bg-secondary';
            default:
                return 'bg-secondary';
        }
    }
});
</script>
{% endblock %}