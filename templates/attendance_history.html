{% extends "base.html" %}

{% block title %}考勤记录 - 考勤系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">考勤记录</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn">
                        <i class="bi bi-download"></i> 导出
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="filterBtn">
                        <i class="bi bi-funnel"></i> 筛选
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选表单 -->
<div class="row" id="filterForm" style="display: none;">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">筛选条件</h5>
            </div>
            <div class="card-body">
                <form id="attendanceFilterForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="startDate" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="startDate" name="start_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="endDate" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="endDate" name="end_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="status" class="form-label">状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">全部</option>
                                <option value="正常">正常</option>
                                <option value="迟到">迟到</option>
                                <option value="早退">早退</option>
                                <option value="缺勤">缺勤</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="department" class="form-label">部门</label>
                            <select class="form-select" id="department" name="department_id">
                                <option value="">全部</option>
                                <option value="1">技术部</option>
                                <option value="2">人事部</option>
                                <option value="3">财务部</option>
                                <option value="4">市场部</option>
                                <option value="5">行政部</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> 查询
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetFilterBtn">
                                <i class="bi bi-arrow-clockwise"></i> 重置
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="hideFilterBtn">
                                <i class="bi bi-x"></i> 关闭
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 统计信息 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">总出勤天数</h5>
                <h2 id="totalDays">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">正常天数</h5>
                <h2 id="normalDays">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">迟到次数</h5>
                <h2 id="lateCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title">缺勤次数</h5>
                <h2 id="absentCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- 考勤记录表格 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">考勤记录列表</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="attendanceTable">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>员工编号</th>
                                <th>姓名</th>
                                <th>部门</th>
                                <th>上班时间</th>
                                <th>下班时间</th>
                                <th>工作时长</th>
                                <th>状态</th>
                                {% if current_user.is_admin %}
                                <th>操作</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="考勤记录分页">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 修改考勤记录模态框 -->
{% if current_user.is_admin %}
<div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-labelledby="editAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAttendanceModalLabel">修改考勤记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAttendanceForm">
                    <input type="hidden" id="attendanceId" name="attendance_id">
                    
                    <div class="mb-3">
                        <label for="editDate" class="form-label">日期</label>
                        <input type="date" class="form-control" id="editDate" name="date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCheckInTime" class="form-label">上班时间</label>
                        <input type="time" class="form-control" id="editCheckInTime" name="check_in_time">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editCheckOutTime" class="form-label">下班时间</label>
                        <input type="time" class="form-control" id="editCheckOutTime" name="check_out_time">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">状态</label>
                        <select class="form-select" id="editStatus" name="status" required>
                            <option value="正常">正常</option>
                            <option value="迟到">迟到</option>
                            <option value="早退">早退</option>
                            <option value="缺勤">缺勤</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editRemark" class="form-label">备注</label>
                        <textarea class="form-control" id="editRemark" name="remark" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveAttendanceBtn">保存</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化变量
    let currentPage = 1;
    let pageSize = 10;
    let totalItems = 0;
    let currentFilters = {};
    
    // 加载考勤记录
    loadAttendanceRecords();
    
    // 加载统计信息
    loadStatistics();
    
    // 筛选按钮点击事件
    document.getElementById('filterBtn').addEventListener('click', function() {
        const filterForm = document.getElementById('filterForm');
        filterForm.style.display = filterForm.style.display === 'none' ? 'block' : 'none';
    });
    
    // 隐藏筛选表单
    document.getElementById('hideFilterBtn').addEventListener('click', function() {
        document.getElementById('filterForm').style.display = 'none';
    });
    
    // 筛选表单提交
    document.getElementById('attendanceFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 获取筛选条件
        const formData = new FormData(this);
        currentFilters = Object.fromEntries(formData.entries());
        
        // 重置页码并重新加载数据
        currentPage = 1;
        loadAttendanceRecords();
        loadStatistics();
    });
    
    // 重置筛选条件
    document.getElementById('resetFilterBtn').addEventListener('click', function() {
        document.getElementById('attendanceFilterForm').reset();
        currentFilters = {};
        currentPage = 1;
        loadAttendanceRecords();
        loadStatistics();
    });
    
    // 导出按钮点击事件
    document.getElementById('exportBtn').addEventListener('click', function() {
        exportAttendanceRecords();
    });
    
    // 保存考勤记录修改
    document.getElementById('saveAttendanceBtn').addEventListener('click', function() {
        saveAttendanceRecord();
    });
    
    // 加载考勤记录函数
    function loadAttendanceRecords() {
        const params = new URLSearchParams();
        params.append('page', currentPage);
        params.append('page_size', pageSize);
        
        // 添加筛选条件
        Object.keys(currentFilters).forEach(key => {
            if (currentFilters[key]) {
                params.append(key, currentFilters[key]);
            }
        });
        
        axios.get(`/api/v1/attendance?${params.toString()}`)
            .then(response => {
                const data = response.data;
                
                // 更新分页信息
                totalItems = data.total;
                updatePagination();
                
                // 更新表格数据
                updateAttendanceTable(data.items);
            })
            .catch(error => {
                console.error('加载考勤记录失败:', error);
                showToast('加载考勤记录失败', 'danger');
            });
    }
    
    // 更新分页控件
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(totalItems / pageSize);
        
        // 上一页按钮
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>`;
        pagination.appendChild(prevLi);
        
        // 页码按钮
        for (let i = 1; i <= totalPages; i++) {
            // 只显示当前页附近的页码
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                // 添加省略号
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<a class="page-link" href="#">...</a>';
                pagination.appendChild(li);
            }
        }
        
        // 下一页按钮
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>`;
        pagination.appendChild(nextLi);
        
        // 添加页码点击事件
        pagination.querySelectorAll('.page-link:not(.disabled)').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page !== currentPage) {
                    currentPage = page;
                    loadAttendanceRecords();
                }
            });
        });
    }
    
    // 加载统计信息
    function loadStatistics() {
        const params = new URLSearchParams();
        
        // 添加筛选条件
        Object.keys(currentFilters).forEach(key => {
            if (currentFilters[key]) {
                params.append(key, currentFilters[key]);
            }
        });
        
        axios.get(`/api/v1/attendance/statistics?${params.toString()}`)
            .then(response => {
                const data = response.data;
                
                document.getElementById('totalDays').textContent = data.total_days || 0;
                document.getElementById('normalDays').textContent = data.normal_days || 0;
                document.getElementById('lateCount').textContent = data.late_count || 0;
                document.getElementById('absentCount').textContent = data.absent_count || 0;
            })
            .catch(error => {
                console.error('加载统计信息失败:', error);
            });
    }
    
    // 编辑考勤记录
    function editAttendanceRecord(attendanceId) {
        axios.get(`/api/v1/attendance/${attendanceId}`)
            .then(response => {
                const data = response.data;
                
                // 填充表单
                document.getElementById('attendanceId').value = data.id;
                document.getElementById('editDate').value = data.date;
                document.getElementById('editCheckInTime').value = data.check_in_time || '';
                document.getElementById('editCheckOutTime').value = data.check_out_time || '';
                document.getElementById('editStatus').value = data.status;
                document.getElementById('editRemark').value = data.remark || '';
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('editAttendanceModal'));
                modal.show();
            })
            .catch(error => {
                console.error('获取考勤记录失败:', error);
                showToast('获取考勤记录失败', 'danger');
            });
    }
    
    // 保存考勤记录修改
    function saveAttendanceRecord() {
        const attendanceId = document.getElementById('attendanceId').value;
        const formData = new FormData(document.getElementById('editAttendanceForm'));
        const data = Object.fromEntries(formData.entries());
        
        axios.put(`/api/v1/attendance/${attendanceId}`, data)
            .then(response => {
                showToast('修改成功', 'success');
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal'));
                modal.hide();
                
                // 重新加载数据
                loadAttendanceRecords();
                loadStatistics();
            })
            .catch(error => {
                console.error('修改考勤记录失败:', error);
                showToast(error.response?.data?.detail || '修改失败', 'danger');
            });
    }
    
    // 导出考勤记录
    function exportAttendanceRecords() {
        const params = new URLSearchParams();
        
        // 添加筛选条件
        Object.keys(currentFilters).forEach(key => {
            if (currentFilters[key]) {
                params.append(key, currentFilters[key]);
            }
        });
        
        // 打开导出链接
        window.open(`/api/v1/attendance/export?${params.toString()}`, '_blank');
    }
    
    // 获取状态徽章样式
    function getStatusBadgeClass(status) {
        switch(status) {
            case '正常':
                return 'bg-success';
            case '迟到':
                return 'bg-warning';
            case '早退':
                return 'bg-warning';
            case '缺勤':
                return 'bg-danger';
            default:
                return 'bg-secondary';
        }
    }
});
</script>
{% endblock %}